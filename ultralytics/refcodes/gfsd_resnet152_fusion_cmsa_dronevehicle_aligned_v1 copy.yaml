# parameters
nc: 8  # number of classes
depth_multiple: 1.00  # model depth multiple
width_multiple: 1.00  # layer channel multiple

# defrcn parameters
# MODE: 'finetune'  #[finetune, 'train']
BACKWARD_SCALE: 0.01    # base 0.75 novel 0.01
BACKBONE_LAYER_NUM: 46
DETECT_LAYER_ID: 56
# LAST_LAYER: 60

# gfsd parameters
cosine: False
base_nc: 5    # base only
novel_nc: 3   # novel only
COSINE_SCALE: 20        # weight mult cosine of novel head, only effect when 'cosine' is 'True'
conf_thres: 0.01
base_bonus: 0.1         # bonua added to base head
consistency_coeff: 0.1 #  0.1  # weight of cls_consistency_loss
base_model: 'runs/base/v1_base/weights/best.pt'
novel_model: ''

# anchors
anchors:
  - [10,13, 16,30, 33,23]   # P3/8
  - [30,61, 62,45, 59,119]  # P4/16
  - [116,90, 156,198, 373,326]  # P5/32

# YOLOv5 backbone
backbone:
  # [from, number, module, args]
  # Two Stream
  [
    # stream one
    [-1, 1, ResNet_stem, [64, 2]],               # 0-P1/2
    [-1, 1, ResNet_layer, [256, 3, 1]],                    # 1

    # stream two
    [-4, 1, ResNet_stem, [64, 2]],               # 2-P1/2
    [-1, 1, ResNet_layer, [256, 3, 1]],                    # 3


    # transformer fusion
    [1, 1, ResNet_layer, [512, 8, 2]],                    # 4
    [-1, 1, nn.AvgPool2d, [4, 4]],                        # 5
    [3, 1, ResNet_layer, [512, 8, 2]],                    # 6
    [-1, 1, nn.AvgPool2d, [4, 4]],                        # 7
    [[5,7], 3, CMSABlock, []],        # 8-P3/8    [channel , sra  ,h , w,number]  80*80
    [8, 1, Get2, [512,0]],                   # 9-P3/8 stream one x+trans[0]
    [-1, 1, nn.Upsample, [None, 4, 'bilinear']], # 10
    [8, 1, Get2, [512,1]],                   # 11-P3/8 stream two x+trans[1]
    [-1, 1, nn.Upsample, [None, 4, 'bilinear']], # 12


    # stream one
    [10, 1, ResNet_layer, [1024, 36, 2]],                   # 13-P4/16
    [-1, 1, nn.AvgPool2d, [2, 2]],                        # 14
    # stream two
    [12, 1, ResNet_layer, [1024, 36, 2]],                   # 15-P4/16
    [-1, 1, nn.AvgPool2d, [2, 2]],                        # 16
    # transformer fusion
    [[14,16], 3, CMSABlock, []],      # 17-P3/16     [channel , sra  ,h , w,number] 40*40
    [17, 1, Get2, [1024,0]],                  # 18-P3/16 stream one x+trans[0]
    [-1, 1, nn.Upsample, [None, 2, 'bilinear']], # 19
    [17, 1, Get2, [1024,1]],                  # 20-P3/16 stream two x+trans[1]
    [-1, 1, nn.Upsample, [None, 2, 'bilinear']], # 21


    # stream one
    [19, 1, ResNet_layer, [2048, 3, 2]],                  # 22-P5/32
    # stream two
    [21, 1, ResNet_layer, [2048, 3, 2]],                  # 23-P5/32
    # transformer fusion
    [[22,23], 3, CMSABlock, []],     # 24-P5/32     [channel , sra  ,h , w,number] 20*20
    [24, 1, Get2, [2048,0]],                 # 25-P5/32 stream one x+trans[0]
    [24, 1, Get2, [2048,1]],                 # 26-P5/32 stream two x+trans[1]


    [[1,3], 1, Concat, [1]],                       # 27-P2/4
    [-1, 1, Conv, [256, 3, 1]],                       # 28-P2/4 fusion backbone P2
    [[10,12], 1, Concat, [1]],                       # 29-P3/8
    [-1, 1, Conv, [512, 3, 1]],                       # 30-P3/8 fusion backbone P3
    [[19,21], 1, Concat, [1]],                       # 31-P4/16
    [-1, 1, Conv, [1024, 3, 1]],                       # 32-P4/16 fusion backbone P4
    [[25,26], 1, Concat, [1]],                       # 33-P5/32
    [-1, 1, Conv, [2048, 3, 1]],                       # 34-P5/32 fusion backbone P5

  ]


# YOLOv5 head
head:
  [
    [-1, 1, Conv, [1024, 1, 1]],                   # 35
    [-1, 1, nn.Upsample, [None, 2, 'nearest']],   # 36
    [[-1,32], 1, Concat, [1]],                    # 37 cat backbone P4
    [-1, 3, C2f, [1024, False]],                   # 38

    [-1, 1, Conv, [512, 1, 1]],                   # 39
    [-1, 1, nn.Upsample, [None, 2, 'nearest']],   # 40
    [[-1,30], 1, Concat, [1]],                    # 41 cat backbone P3
    [-1, 3, C2f, [512, False]],                   # 42

    [-1, 1, Conv, [256, 1, 1]],                   # 43
    [-1, 1, nn.Upsample, [None, 2, 'nearest']],   # 44
    [[-1,28], 1, Concat, [1]],                    # 45 cat backbone P2
    [-1, 3, C2f, [256, False]],                   # 46

    [-1, 1, Conv, [256, 3, 2]],                   # 47
    [[-1,43], 1, Concat, [1]],                    # 48 cat head P3
    [-1, 3, C2f, [512, False]],                   # 49 (P3/8-medium)

    [-1, 1, Conv, [512, 3, 2]],                   # 50
    [[-1,39], 1, Concat, [1]],                    # 51 cat head P4
    [-1, 3, C2f, [1024, False]],                   # 52 (P4/16-medium)

    [-1, 1, Conv, [1024, 3, 2]],                   # 53
    [[-1,35], 1, Concat, [1]],                    # 54 cat head P5
    [-1, 3, C2f, [2048, False]],                  # 55 (P5/32-large)

    # [[49, 52, 55], 1, Detect, [nc, anchors]],     # Detect(P3, P4, P5)
    [[49, 52, 55], 1, ReDetect, [nc, anchors]],     # Redetect(P3, P4, P5)
  ]


